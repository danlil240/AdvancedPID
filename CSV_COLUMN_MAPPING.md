# CSV Column Mapping Guide

## Overview

The system identification module is designed to work seamlessly with CSV files generated by the `CSVLogger` class in the PID library. This document explains the column mapping between what the PID controller logs and what the system identification expects.

## Column Names

### CSVLogger Output → System Identification Input

| CSVLogger Column | System ID Parameter | Description |
|------------------|---------------------|-------------|
| `timestamp` | `time_col` | Time in seconds |
| `output` | `input_col` | Control signal from PID controller (what goes to actuator) |
| `measurement` | `output_col` | Process variable measurement (what comes from sensor) |
| `setpoint` | `setpoint_col` | Desired value (optional) |
| `error` | `error_col` | Tracking error (optional) |

### Why This Mapping?

**From PID Controller Perspective:**
- `output` = What the PID controller outputs (control signal)
- `measurement` = What the PID controller measures (process variable)

**From System Identification Perspective:**
- `input` = Input to the system (control signal) ← This is the PID's `output`
- `output` = Output from the system (measurement) ← This is the PID's `measurement`

## Default Configuration

The `AutotuneFromData` class defaults are configured to match `CSVLogger` output:

```python
from pid_control.identification.autotune_from_data import AutotuneFromData

# This works automatically with CSVLogger files
autotuner = AutotuneFromData('pid_log.csv')
result = autotuner.autotune()
```

**Default parameters:**
- `time_col='timestamp'` ← matches CSVLogger
- `input_col='output'` ← PID output is system input
- `output_col='measurement'` ← PID measurement is system output
- `setpoint_col='setpoint'` ← optional

## Complete Workflow Example

### Step 1: Collect Data with PID Controller

```python
from pid_control import PIDController, PIDParams
from pid_control.plants import FirstOrderPlant

# Create plant and controller
plant = FirstOrderPlant(gain=2.0, time_constant=1.5, sample_time=0.01)
params = PIDParams(kp=1.0, ki=0.5, kd=0.1, sample_time=0.01)

# Controller with CSV logging
controller = PIDController(params, csv_path="system_data.csv")

# Run control loop
setpoint = 100.0
measurement = 0.0

for i in range(1000):
    output = controller.update(setpoint, measurement)
    measurement = plant.update(output)

controller.close()
```

**Generated CSV (`system_data.csv`):**
```csv
timestamp,setpoint,measurement,error,p_term,i_term,d_term,output_unsat,output,...
0.00,100.0,0.0,100.0,100.0,0.0,0.0,100.0,100.0,...
0.01,100.0,0.5,99.5,99.5,0.5,5.0,105.0,100.0,...
0.02,100.0,1.2,98.8,98.8,1.0,4.5,104.3,100.0,...
...
```

### Step 2: Identify System and Optimize PID

```python
from pid_control.identification.autotune_from_data import AutotuneFromData

# Load the logged data and optimize
autotuner = AutotuneFromData('system_data.csv')
result = autotuner.autotune()

# Get optimal gains
print(f"Optimal PID Gains:")
print(f"  Kp = {result.optimized_gains['kp']:.4f}")
print(f"  Ki = {result.optimized_gains['ki']:.4f}")
print(f"  Kd = {result.optimized_gains['kd']:.4f}")
```

### Step 3: Apply Optimized Gains

```python
# Update controller with optimized gains
optimized_params = PIDParams(
    kp=result.optimized_gains['kp'],
    ki=result.optimized_gains['ki'],
    kd=result.optimized_gains['kd'],
    sample_time=0.01
)

controller = PIDController(optimized_params)
# Continue with improved control...
```

## Custom CSV Files

If your CSV file has different column names, specify them explicitly:

```python
autotuner = AutotuneFromData(
    'custom_data.csv',
    time_col='time',           # Your time column name
    input_col='control_signal', # Your control signal column
    output_col='sensor_value',  # Your measurement column
    setpoint_col='target'       # Your setpoint column (optional)
)
```

## Common Scenarios

### Scenario 1: Using CSVLogger Output (Default)

```python
# No parameters needed - defaults match CSVLogger
autotuner = AutotuneFromData('pid_log.csv')
result = autotuner.autotune()
```

### Scenario 2: Custom Column Names

```python
autotuner = AutotuneFromData(
    'my_data.csv',
    time_col='t',
    input_col='u',
    output_col='y'
)
result = autotuner.autotune()
```

### Scenario 3: External Data (Not from PID)

If you have data from a different source:

```python
# Your CSV: time,actuator_cmd,sensor_reading,desired_value
autotuner = AutotuneFromData(
    'external_data.csv',
    time_col='time',
    input_col='actuator_cmd',
    output_col='sensor_reading',
    setpoint_col='desired_value'
)
result = autotuner.autotune()
```

## Verification

To verify your CSV file is compatible:

```python
from pid_control.identification import CSVDataReader

reader = CSVDataReader('your_file.csv')

# Try reading with default columns (for CSVLogger files)
try:
    data = reader.read()
    print("✓ Compatible with default CSVLogger format")
except ValueError as e:
    print(f"✗ Need custom column names: {e}")
    
    # Try with custom columns
    data = reader.read(
        time_col='your_time_col',
        input_col='your_input_col',
        output_col='your_output_col'
    )
    print("✓ Successfully loaded with custom columns")

print(f"Loaded {len(data.time)} samples")
print(f"Sample time: {data.sample_time:.4f} s")
```

## Quick Reference

### CSVLogger Standard Format
```csv
timestamp,output,measurement,setpoint
0.00,0.0,25.2,50.0
0.01,5.2,25.3,50.0
...
```

### System Identification Interpretation
- `timestamp` → Time axis for analysis
- `output` → Input to the physical system (control signal)
- `measurement` → Output from the physical system (sensor reading)
- `setpoint` → Reference for performance evaluation

### Key Point
**The PID controller's `output` becomes the system's `input` for identification purposes.**

This is because we're identifying the physical system (plant), not the controller. The plant receives the control signal as input and produces the measurement as output.

## Troubleshooting

### Error: "Time column 'time' not found in CSV"

**Solution:** Your CSV uses different column names. Either:
1. Use CSVLogger format with `timestamp` column, or
2. Specify custom column names:
   ```python
   autotuner = AutotuneFromData('data.csv', time_col='your_time_column')
   ```

### Error: "Input column 'input' not found in CSV"

**Solution:** Specify the correct column name for the control signal:
```python
autotuner = AutotuneFromData('data.csv', input_col='your_control_column')
```

### Error: "Output column 'output' not found in CSV"

**Solution:** Specify the correct column name for the measurement:
```python
autotuner = AutotuneFromData('data.csv', output_col='your_measurement_column')
```

## Summary

✅ **Default configuration works with CSVLogger output**
✅ **Column mapping: PID output → System input, PID measurement → System output**
✅ **Custom column names supported for external data**
✅ **Seamless integration between data collection and identification**

For more details, see:
- [SYSTEM_IDENTIFICATION_GUIDE.md](SYSTEM_IDENTIFICATION_GUIDE.md)
- [DATA_REQUIREMENTS.md](DATA_REQUIREMENTS.md)
